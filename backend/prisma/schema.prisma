generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////// ENUMS ////////////////////

enum Role {
  USER
  HOST
  ADMIN
}

enum AdminRole {
  SUPER_ADMIN
  SUPPORT
  MODERATOR
  FINANCE
  ANALYST
}

enum ListingStatus {
  ACTIVE
  INACTIVE
  PENDING
  SOLD_OUT
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
  REFUNDED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  BOOKING_CREATED
  BOOKING_UPDATED
  BOOKING_CANCELLED
  NEW_REVIEW
  MESSAGE
  SYSTEM
}

//////////////////// MODELS ////////////////////

model User {
  id               Int       @id @default(autoincrement())
  name             String
  email            String    @unique
  password         String
  role             Role      @default(USER)
  adminRole        AdminRole?
  profilePhoto     String?
  lastNameChange   DateTime?
  phone            String?
  bio              String?
  isVerified       Boolean   @default(false)
  stripeCustomerId String?

  // Google OAuth
  googleId       String?   @unique
  emailVerified  Boolean   @default(false)

  // Admin safety
  suspended        Boolean   @default(false)
  suspendedReason  String?
  riskScore        Int       @default(0)
  verifiedByAdmin  Boolean   @default(false)

  // Activity tracking
  lastLoginAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Core relations
  listings         Listing[]
  bookings         Booking[]
  reviews          Review[]
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  notifications    Notification[]
  savedListings    SavedListing[]
  helpfulReviews   Review[]  @relation("HelpfulReviews")
  images           Image[]   @relation("UserImages")

  // Admin relations
  adminProfile        AdminProfile?
  auditLogs           AuditLog[]           @relation("AdminAuditLogs")
  listingModerations  ListingModeration[]  @relation("AdminListingModerations")
  reviewReports       ReviewReport[]       @relation("UserReviewReports")
  adminRefunds        Refund[]             @relation("AdminRefunds")

  @@index([email])
  @@index([role])
}

model AdminProfile {
  id        Int       @id @default(autoincrement())
  userId    Int       @unique
  role      AdminRole
  createdAt DateTime  @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([role])
}

model Listing {
  id               Int           @id @default(autoincrement())
  hostId           Int
  title            String
  slug             String        @unique
  description      String?
  location         String
  address          String?
  latitude         Decimal?      @db.Decimal(10, 8)
  longitude        Decimal?      @db.Decimal(11, 8)

  // Pricing
  hourlyRate       Decimal       @db.Decimal(10, 2)
 
  minHours         Int           @default(1)
  maxHours         Int           @default(12)
  includedGuests   Int           @default(10)
  extraGuestCharge Decimal?      @db.Decimal(10, 2)

  durationDiscounts Json?         // Flexible tiered discounts
  bonusHoursOffer       Json?     // { minHours: 4, bonusHours: 1 }

  // Booking Settings (Host configurable)
  autoConfirm        Boolean   @default(false)     // Auto-confirm bookings without host approval
  minAdvanceBooking  Int       @default(24)        // Minimum hours before booking (default: 24 hours)
  maxAdvanceBooking  Int       @default(90)        // Maximum days in advance (default: 90 days / 3 months)
  instantBooking     Boolean   @default(true)      // Allow instant booking vs request-to-book

  // Details
  operatingHours   Json?
  amenities        String[]
  capacity         Int
  minCapacity      Int           @default(1)
  size             String?
  rules            String[]

  // Status & Visibility
  status           ListingStatus @default(ACTIVE)
  featured         Boolean       @default(false)
  views            Int           @default(0)

  // Featured listing (Admin controlled)
  isFeatured        Boolean   @default(false)
  featuredUntil     DateTime?
  featuredPriority  Int       @default(0)

  // Discount (Host can set, Admin can override)
  discountPercent   Int       @default(0)
  discountFrom      DateTime?                  // When discount starts
  discountUntil     DateTime?                  // When discount ends
  discountReason    String?                    // "Holiday Sale", "New Listing", etc.

  // Promoted listing (Future monetization)
  isPromoted        Boolean   @default(false)
  promotedUntil     DateTime?

  // Analytics
  viewCount         Int       @default(0)
  bookingCount      Int       @default(0)

  // Timestamps
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  host             User          @relation(fields: [hostId], references: [id], onDelete: Cascade)
  images           Image[]       @relation("ListingImages")
  bookings         Booking[]
  reviews          Review[]
  blockedDates     BlockedDate[]
  savedBy          SavedListing[]
  messages         Message[]
  analytics        Analytics[]
  moderations      ListingModeration[]
  specialPricing   SpecialPricing[]
  promotionRequests PromotionRequest[]

  @@index([hostId])
  @@index([status])
  @@index([featured])
  @@index([isFeatured])
  @@index([discountPercent])
}

// Special pricing for specific dates (holidays, weekends, etc.)
model SpecialPricing {
  id          Int       @id @default(autoincrement())
  listingId   Int
  date        DateTime  @db.Date
  hourlyRate  Decimal   @db.Decimal(10, 2)
  reason      String?   // e.g., "Holiday", "Peak Season", "Weekend"
  createdAt   DateTime  @default(now())

  listing     Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date])
  @@index([listingId])
  @@index([date])
}

// Promotion requests from hosts
model PromotionRequest {
  id          Int       @id @default(autoincrement())
  listingId   Int
  hostId      Int
  duration    Int       @default(7)   // Requested days of promotion
  message     String?                  // Why they should be featured
  status      String    @default("PENDING")  // PENDING, APPROVED, REJECTED
  adminId     Int?                     // Admin who reviewed
  adminNote   String?                  // Admin response/reason
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())

  listing     Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([hostId])
  @@index([status])
}

model Image {
  id        Int      @id @default(autoincrement())
  url       String
  s3Key     String
  isCover   Boolean  @default(false)
  order     Int      @default(0)
  createdAt DateTime @default(now())

  listingId Int?
  userId    Int?

  listing   Listing? @relation("ListingImages", fields: [listingId], references: [id], onDelete: Cascade)
  user      User?    @relation("UserImages", fields: [userId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([userId])
}

model Booking {
  id               Int           @id @default(autoincrement())
  bookingNumber    String        @unique @default(uuid())
  userId           Int
  listingId        Int

  bookingDate      DateTime
  startTime        String
  endTime          String
  duration         Decimal       @db.Decimal(5,2)
  guests           Int           @default(1)

  // Pricing breakdown
  basePrice        Decimal       @db.Decimal(10,2)
  extraGuestPrice  Decimal       @db.Decimal(10,2) @default(0)
  serviceFee       Decimal       @db.Decimal(10,2) @default(0)
  tax              Decimal       @db.Decimal(10,2) @default(0)
  discountAmount   Decimal       @db.Decimal(10,2) @default(0)  // Track discount applied
  totalPrice       Decimal       @db.Decimal(10,2)

  status           BookingStatus @default(PENDING)
  paymentStatus    String        @default("pending")
  stripePaymentId  String?

  specialRequests  String?
  cancellationReason String?

  canReview        Boolean       @default(false)
  hasReviewed      Boolean       @default(false)

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  cancelledAt      DateTime?
  completedAt      DateTime?

  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing          Listing       @relation(fields: [listingId], references: [id], onDelete: Cascade)
  review           Review?
  refunds          Refund[]

  @@index([userId])
  @@index([listingId])
  @@index([status])
  @@index([bookingDate])
}

model Review {
  id          Int       @id @default(autoincrement())
  bookingId   Int       @unique
  listingId   Int
  userId      Int

  rating      Int
  title       String?
  comment     String

  // Detailed ratings
  cleanliness   Decimal?  @db.Decimal(2,1)
  accuracy      Decimal?  @db.Decimal(2,1)
  communication Decimal?  @db.Decimal(2,1)
  location      Decimal?  @db.Decimal(2,1)
  checkin       Decimal?  @db.Decimal(2,1)
  value         Decimal?  @db.Decimal(2,1)

  status       ReviewStatus @default(APPROVED)
  helpfulCount Int          @default(0)
  reported     Boolean      @default(false)

  // Host response
  hostResponse  String?
  respondedAt   DateTime?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  booking     Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  listing     Listing    @relation(fields: [listingId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  helpfulUsers User[]    @relation("HelpfulReviews")
  reports     ReviewReport[]

  @@index([listingId])
  @@index([rating])
}

//////////////////// ADMIN MODELS ////////////////////

model AuditLog {
  id        Int      @id @default(autoincrement())
  adminId   Int
  action    String
  entity    String
  entityId  Int?
  before    Json?
  after     Json?
  ip        String?
  createdAt DateTime @default(now())

  admin     User     @relation("AdminAuditLogs", fields: [adminId], references: [id])

  @@index([adminId])
  @@index([createdAt])
}

model ListingModeration {
  id        Int      @id @default(autoincrement())
  listingId Int
  adminId   Int
  status    ListingStatus
  reason    String?
  createdAt DateTime @default(now())

  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  admin     User     @relation("AdminListingModerations", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([adminId])
}

model ReviewReport {
  id        Int      @id @default(autoincrement())
  reviewId  Int
  userId    Int
  reason    String
  createdAt DateTime @default(now())

  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User     @relation("UserReviewReports", fields: [userId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([userId])
}

model Refund {
  id        Int      @id @default(autoincrement())
  bookingId Int
  adminId   Int
  amount    Decimal  @db.Decimal(10,2)
  reason    String
  createdAt DateTime @default(now())

  booking  Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  admin    User     @relation("AdminRefunds", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([adminId])
}

model AbuseReport {
  id         Int      @id @default(autoincrement())
  reporterId Int
  targetType String
  targetId   Int
  reason     String
  resolved   Boolean  @default(false)
  adminId    Int?
  createdAt  DateTime @default(now())

  @@index([resolved])
}

model PlatformMetric {
  id        Int      @id @default(autoincrement())
  date      DateTime
  metric    String
  value     Decimal

  @@unique([date, metric])
  @@index([date])
}

model FeatureFlag {
  id      Int     @id @default(autoincrement())
  key     String  @unique
  enabled Boolean @default(false)
  data    Json?
}

model BlockedDate {
  id        Int      @id @default(autoincrement())
  listingId Int
  date      DateTime @db.Date
  reason    String?
  createdAt DateTime @default(now())

  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date])
  @@index([listingId])
}

model SavedListing {
  id        Int      @id @default(autoincrement())
  userId    Int
  listingId Int
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@index([userId])
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  type      NotificationType
  title     String
  message   String
  data      Json?
  read      Boolean         @default(false)
  createdAt DateTime        @default(now())

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

model Message {
  id         Int      @id @default(autoincrement())
  senderId   Int
  receiverId Int
  listingId  Int?
  content    String
  read       Boolean @default(false)
  createdAt  DateTime @default(now())

  sender     User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  listing    Listing? @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([read])
}

model Analytics {
  id        Int      @id @default(autoincrement())
  date      DateTime @default(now())
  metric    String
  value     Json
  listingId Int?

  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([listingId])
}
