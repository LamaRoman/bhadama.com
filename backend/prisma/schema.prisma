generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum TierType {
  FREE
  BASIC
  PRO
  PREMIUM
}

enum BillingCycle {
  WEEKLY
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  EXPIRED
  CANCELLED
  PAST_DUE
  PAUSED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentGatewayType {
  ESEWA
  KHALTI
  DODO
  MANUAL
  PENDING
}

enum Currency {
  NPR
  USD
  INR
}

enum PaymentType {
  FULL
  PRORATED
  RENEWAL
  MANUAL
  REFUND
}

enum Role {
  USER
  HOST
  ADMIN
}

enum AdminRole {
  SUPER_ADMIN
  SUPPORT
  MODERATOR
  FINANCE
  ANALYST
}

enum ListingStatus {
  ACTIVE
  INACTIVE
  PENDING
  SOLD_OUT
  OVER_LIMIT
  ARCHIVED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
  REFUNDED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  BOOKING_CREATED
  BOOKING_UPDATED
  BOOKING_CANCELLED
  NEW_REVIEW
  MESSAGE
  SYSTEM
  BLOG_APPROVED
  BLOG_REJECTED
  BLOG_COMMENT
  BLOG_LIKE
}

enum BlogStatus {
  DRAFT
  PENDING
  PUBLISHED
  REJECTED
  ARCHIVED
}

enum BlogCategory {
  SPACE_TOUR
  HOSTING_TIPS
  LOCAL_GUIDE
  ANNOUNCEMENT
  EVENT_EXPERIENCE
  PLANNING_TIPS
  VENUE_REVIEW
  INSPIRATION
  GENERAL
}

enum CommentStatus {
  VISIBLE
  HIDDEN
  FLAGGED
  DELETED
}

// ==========================================
// HOST TIER SYSTEM
// ==========================================

model HostTier {
  id          Int       @id @default(autoincrement())
  name        TierType  @unique
  displayName String
  description String?
  
  // Limits
  maxListings         Int       @default(2)
  maxPhotosPerListing Int       @default(5)
  maxBlogPostsPerMonth Int      @default(2)
  featuredListingSlots Int      @default(0)
  
  // Commission
  commissionPercent   Float     @default(10.0)
  
  // Features
  features            Json?
  
  // Trial
  trialDays           Int       @default(0)
  
  // Status
  isActive            Boolean   @default(true)
  sortOrder           Int       @default(0)
  
  // Timestamps
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Relations
  pricing                 TierPricing[]
  subscriptions           HostSubscription[]  @relation("CurrentTier")
  previousSubscriptions   HostSubscription[]  @relation("PreviousTier")
  pendingSubscriptions    HostSubscription[]  @relation("PendingTier")
  
  @@map("host_tiers")
}

model TierPricing {
  id            Int          @id @default(autoincrement())
  tierId        Int
  tier          HostTier     @relation(fields: [tierId], references: [id], onDelete: Cascade)
  
  billingCycle  BillingCycle
  currency      Currency     @default(NPR)
  
  price         Float
  discountPercent Float      @default(0)
  finalPrice    Float
  
  isActive      Boolean      @default(true)
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@unique([tierId, billingCycle, currency])
  @@map("tier_pricing")
}

model HostSubscription {
  id              Int                @id @default(autoincrement())
  
  // Host reference
  hostId          Int       @unique
  host            User               @relation(fields: [hostId], references: [id], onDelete: Cascade)
  
  // Current tier
  tierId          Int
  tier            HostTier           @relation("CurrentTier", fields: [tierId], references: [id])
  
  // Tier change tracking
  previousTierId          Int?
  previousTier            HostTier?         @relation("PreviousTier", fields: [previousTierId], references: [id])
  
  pendingTierId           Int?
  pendingTier             HostTier?         @relation("PendingTier", fields: [pendingTierId], references: [id])
  
  tierChangeScheduledAt   DateTime?
  
  // Listing selection tracking
  listingSelectionDeadline DateTime?
  excessListingsCount     Int       @default(0)
  
  // Subscription details
  billingCycle    BillingCycle?
  currency        Currency           @default(NPR)
  
  status          SubscriptionStatus @default(ACTIVE)
  
  // Dates
  startDate       DateTime           @default(now())
  endDate         DateTime?
  trialEndDate    DateTime?
  
  // Grace period tracking
  gracePeriodEnd  DateTime?
  
  // Auto-renew
  autoRenew       Boolean            @default(true)
  
  // Cancellation
  cancelledAt     DateTime?
  cancelReason    String?
  
  // Timestamps
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  // Relations
  payments        Payment[]
  history         SubscriptionHistory[]
  
  @@map("host_subscriptions")
}

model SubscriptionHistory {
  id              Int                @id @default(autoincrement())
  
  subscriptionId  Int
  subscription    HostSubscription   @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  // What changed
  action          String
  fromTier        TierType?
  toTier          TierType?
  
  // Details
  details         Json?
  
  // Who made the change
  changedBy       Int?
  changedByType   String?
  
  createdAt       DateTime           @default(now())
  
  @@map("subscription_history")
}

model Payment {
  id                  Int                @id @default(autoincrement())
  
  // References
  subscriptionId      Int?
  subscription        HostSubscription?  @relation(fields: [subscriptionId], references: [id])
  
  hostId              Int
  host                User               @relation(fields: [hostId], references: [id])
  
  // Payment details
  amount              Float
  currency            Currency           @default(NPR)
  
  // Gateway info
  gateway             PaymentGatewayType
  gatewayTransactionId String?
  gatewayResponse     Json?
  
  // Status
  status              PaymentStatus      @default(PENDING)
  
  // Description
  description         String?
  
  // Billing period
  periodStart         DateTime?
  periodEnd           DateTime?
  
  // Refund info
  refundedAt          DateTime?
  refundAmount        Float?
  refundReason        String?
  
  // Proration tracking
  type              PaymentType   @default(FULL)
  proratedCredit    Float?
  originalAmount    Float?
  upgradeFromTierId Int?
  metadata          Json?
  
  // Timestamps
  paidAt              DateTime?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  @@map("payments")
}

model PaymentGatewayConfig {
  id            Int                @id @default(autoincrement())
  
  gateway       PaymentGatewayType @unique
  displayName   String
  
  // Credentials
  merchantId    String?
  secretKey     String?
  publicKey     String?
  
  // URLs
  baseUrl       String?
  callbackUrl   String?
  webhookSecret String?
  
  // Settings
  isActive      Boolean            @default(false)
  isTestMode    Boolean            @default(true)
  
  // Supported currencies
  currencies    Currency[]         @default([NPR])
  
  // Countries
  countries     String[]           @default(["NP"])
  
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  
  @@map("payment_gateway_configs")
}

model PlatformSettings {
  id            Int      @id @default(autoincrement())
  key           String   @unique
  value         Json
  description   String?
  
  editableBy    String   @default("SUPER_ADMIN")
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("platform_settings")
}

// ==========================================
// USER MODEL
// ==========================================

model User {
  id               Int       @id @default(autoincrement())
  name             String
  email            String    @unique
  password         String
  role             Role      @default(USER)
  adminRole        AdminRole?
  profilePhoto     String?
  lastNameChange   DateTime?
  phone            String?
  bio              String?
  isVerified       Boolean   @default(false)
  stripeCustomerId String?

  // Google OAuth
  googleId       String?   @unique
  emailVerified  Boolean   @default(false)

  // Admin safety
  suspended        Boolean   @default(false)
  suspendedReason  String?
  riskScore        Int       @default(0)
  verifiedByAdmin  Boolean   @default(false)

  // Activity tracking
  lastLoginAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Tier tracking
  subscription      HostSubscription?
  payments          Payment[]
  currentTier       TierType          @default(FREE)
  tierExpiresAt     DateTime?

  // Core relations
  listings         Listing[]
  bookings         Booking[]
  reviews          Review[]
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  notifications    Notification[]
  savedListings    SavedListing[]
  helpfulReviews   Review[]  @relation("HelpfulReviews")
  images           Image[]   @relation("UserImages")

  // Admin relations
  adminProfile        AdminProfile?
  auditLogs           AuditLog[]           @relation("AdminAuditLogs")
  listingModerations  ListingModeration[]  @relation("AdminListingModerations")
  reviewReports       ReviewReport[]       @relation("UserReviewReports")
  adminRefunds        Refund[]             @relation("AdminRefunds")

  // Blog relations
  blogPosts           BlogPost[]           @relation("BlogAuthor")
  blogComments        BlogComment[]        @relation("BlogCommentAuthor")
  blogLikes           BlogLike[]           @relation("BlogLikesUser")
  blogCommentLikes    BlogCommentLike[]    @relation("CommentLikesUser")
  contributorProfile  ContributorProfile?  @relation("ContributorProfile")

  @@index([email])
  @@index([role])
}

model AdminProfile {
  id        Int       @id @default(autoincrement())
  userId    Int       @unique
  role      AdminRole
  createdAt DateTime  @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([role])
}

// ==========================================
// LISTING MODEL
// ==========================================

model Listing {
  id               Int           @id @default(autoincrement())
  hostId           Int
  title            String
  slug             String        @unique
  description      String?
  location         String
  address          String?
  latitude         Decimal?      @db.Decimal(10, 8)
  longitude        Decimal?      @db.Decimal(11, 8)

  // Pricing
  hourlyRate       Decimal       @db.Decimal(10, 2)
  minHours         Int           @default(1)
  maxHours         Int           @default(12)
  includedGuests   Int           @default(10)
  extraGuestCharge Decimal?      @db.Decimal(10, 2)

  durationDiscounts Json?
  bonusHoursOffer       Json?

  // Booking Settings
  autoConfirm        Boolean   @default(false)
  minAdvanceBooking  Int       @default(24)
  maxAdvanceBooking  Int       @default(90)
  instantBooking     Boolean   @default(true)

  // Details
  operatingHours   Json?
  amenities        String[]
  capacity         Int
  minCapacity      Int           @default(1)
  size             String?
  rules            String[]

  // Status & Visibility
  status           ListingStatus @default(ACTIVE)
  featured         Boolean       @default(false)
  views            Int           @default(0)

  // Featured listing
  isFeatured        Boolean   @default(false)
  featuredUntil     DateTime?
  featuredPriority  Int       @default(0)

  // Discount
  discountPercent   Int       @default(0)
  discountFrom      DateTime?
  discountUntil     DateTime?
  discountReason    String?

  // Promoted listing
  isPromoted        Boolean   @default(false)
  promotedUntil     DateTime?

  // Analytics
  viewCount         Int       @default(0)
  bookingCount      Int       @default(0)

  // Archive tracking
  archivedAt      DateTime?
  archivedReason  String?
  previousStatus  ListingStatus?

  // Timestamps
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  // Relations
  host             User          @relation(fields: [hostId], references: [id], onDelete: Cascade)
  images           Image[]       @relation("ListingImages")
  bookings         Booking[]
  reviews          Review[]
  blockedDates     BlockedDate[]
  savedBy          SavedListing[]
  messages         Message[]
  analytics        Analytics[]
  moderations      ListingModeration[]
  specialPricing   SpecialPricing[]
  promotionRequests PromotionRequest[]
  blogs            BlogPost[]    @relation("ListingBlogs")

  @@index([hostId])
  @@index([status])
  @@index([featured])
  @@index([isFeatured])
  @@index([discountPercent])
}

model SpecialPricing {
  id          Int       @id @default(autoincrement())
  listingId   Int
  date        DateTime  @db.Date
  hourlyRate  Decimal   @db.Decimal(10, 2)
  reason      String?
  createdAt   DateTime  @default(now())

  listing     Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date])
  @@index([listingId])
  @@index([date])
}

model PromotionRequest {
  id          Int       @id @default(autoincrement())
  listingId   Int
  hostId      Int
  duration    Int       @default(7)
  message     String?
  status      String    @default("PENDING")
  adminId     Int?
  adminNote   String?
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())

  listing     Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([hostId])
  @@index([status])
}

model Image {
  id        Int      @id @default(autoincrement())
  url       String
  s3Key     String
  isCover   Boolean  @default(false)
  order     Int      @default(0)
  createdAt DateTime @default(now())

  listingId Int?
  userId    Int?

  listing   Listing? @relation("ListingImages", fields: [listingId], references: [id], onDelete: Cascade)
  user      User?    @relation("UserImages", fields: [userId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([userId])
}

model Booking {
  id               Int           @id @default(autoincrement())
  bookingNumber    String        @unique @default(uuid())
  userId           Int
  listingId        Int

  bookingDate      DateTime
  startTime        String
  endTime          String
  duration         Decimal       @db.Decimal(5,2)
  guests           Int           @default(1)

  // Pricing breakdown
  basePrice        Decimal       @db.Decimal(10,2)
  extraGuestPrice  Decimal       @db.Decimal(10,2) @default(0)
  serviceFee       Decimal       @db.Decimal(10,2) @default(0)
  tax              Decimal       @db.Decimal(10,2) @default(0)
  discountAmount   Decimal       @db.Decimal(10,2) @default(0)
  totalPrice       Decimal       @db.Decimal(10,2)

  status           BookingStatus @default(PENDING)
  paymentStatus    String        @default("pending")
  stripePaymentId  String?

  specialRequests  String?
  cancellationReason String?

  canReview        Boolean       @default(false)
  hasReviewed      Boolean       @default(false)

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  cancelledAt      DateTime?
  completedAt      DateTime?

  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing          Listing       @relation(fields: [listingId], references: [id], onDelete: Cascade)
  review           Review?
  refunds          Refund[]

  @@index([userId])
  @@index([listingId])
  @@index([status])
  @@index([bookingDate])
}

model Review {
  id          Int       @id @default(autoincrement())
  bookingId   Int       @unique
  listingId   Int
  userId      Int

  rating      Int
  title       String?
  comment     String

  // Detailed ratings
  cleanliness   Decimal?  @db.Decimal(2,1)
  accuracy      Decimal?  @db.Decimal(2,1)
  communication Decimal?  @db.Decimal(2,1)
  location      Decimal?  @db.Decimal(2,1)
  checkin       Decimal?  @db.Decimal(2,1)
  value         Decimal?  @db.Decimal(2,1)

  status       ReviewStatus @default(APPROVED)
  helpfulCount Int          @default(0)
  reported     Boolean      @default(false)

  // Host response
  hostResponse  String?
  respondedAt   DateTime?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  booking     Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  listing     Listing    @relation(fields: [listingId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  helpfulUsers User[]    @relation("HelpfulReviews")
  reports     ReviewReport[]

  @@index([listingId])
  @@index([rating])
}

// ==========================================
// ADMIN MODELS
// ==========================================

model AuditLog {
  id        Int      @id @default(autoincrement())
  adminId   Int
  action    String
  entity    String
  entityId  Int?
  before    Json?
  after     Json?
  ip        String?
  createdAt DateTime @default(now())

  admin     User     @relation("AdminAuditLogs", fields: [adminId], references: [id])

  @@index([adminId])
  @@index([createdAt])
}

model ListingModeration {
  id        Int      @id @default(autoincrement())
  listingId Int
  adminId   Int
  status    ListingStatus
  reason    String?
  createdAt DateTime @default(now())

  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  admin     User     @relation("AdminListingModerations", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([adminId])
}

model ReviewReport {
  id        Int      @id @default(autoincrement())
  reviewId  Int
  userId    Int
  reason    String
  createdAt DateTime @default(now())

  review    Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  user      User     @relation("UserReviewReports", fields: [userId], references: [id], onDelete: Cascade)

  @@index([reviewId])
  @@index([userId])
}

model Refund {
  id        Int      @id @default(autoincrement())
  bookingId Int
  adminId   Int
  amount    Decimal  @db.Decimal(10,2)
  reason    String
  createdAt DateTime @default(now())

  booking  Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  admin    User     @relation("AdminRefunds", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([adminId])
}

model AbuseReport {
  id         Int      @id @default(autoincrement())
  reporterId Int
  targetType String
  targetId   Int
  reason     String
  resolved   Boolean  @default(false)
  adminId    Int?
  createdAt  DateTime @default(now())

  @@index([resolved])
}

model PlatformMetric {
  id        Int      @id @default(autoincrement())
  date      DateTime
  metric    String
  value     Decimal

  @@unique([date, metric])
  @@index([date])
}

model FeatureFlag {
  id      Int     @id @default(autoincrement())
  key     String  @unique
  enabled Boolean @default(false)
  data    Json?
}

model BlockedDate {
  id        Int      @id @default(autoincrement())
  listingId Int
  date      DateTime @db.Date
  reason    String?
  createdAt DateTime @default(now())

  listing   Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([listingId, date])
  @@index([listingId])
}

model SavedListing {
  id        Int      @id @default(autoincrement())
  userId    Int
  listingId Int
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@index([userId])
}

model Notification {
  id        Int              @id @default(autoincrement())
  userId    Int
  type      NotificationType
  title     String
  message   String
  data      Json?
  read      Boolean         @default(false)
  createdAt DateTime        @default(now())

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

model Message {
  id         Int      @id @default(autoincrement())
  senderId   Int
  receiverId Int
  listingId  Int?
  content    String
  read       Boolean @default(false)
  createdAt  DateTime @default(now())

  sender     User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  listing    Listing? @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([read])
}

model Analytics {
  id        Int      @id @default(autoincrement())
  date      DateTime @default(now())
  metric    String
  value     Json
  listingId Int?

  listing   Listing? @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([listingId])
}

// ==========================================
// BLOG SYSTEM MODELS
// ==========================================

model BlogPost {
  id              Int           @id @default(autoincrement())
  
  authorId        Int
  authorType      Role
  
  listingId       Int?
  
  title           String        @db.VarChar(200)
  slug            String        @unique
  content         String        @db.Text
  excerpt         String?       @db.VarChar(300)
  
  metaTitle       String?       @db.VarChar(70)
  metaDescription String?       @db.VarChar(170)
  focusKeyword    String?       @db.VarChar(50)
  
  wordCount       Int           @default(0)
  readingTime     Int           @default(0)
  seoScore        Int           @default(0)
  
  coverImage      String?
  coverImageAlt   String?       @db.VarChar(150)
  
  category        BlogCategory  @default(GENERAL)
  tags            String[]      @default([])
  
  status          BlogStatus    @default(DRAFT)
  publishedAt     DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  
  moderatedBy     Int?
  moderatedAt     DateTime?
  adminNote       String?
  
  isFeatured      Boolean       @default(false)
  featuredUntil   DateTime?
  allowComments   Boolean       @default(true)
  
  viewCount       Int           @default(0)
  uniqueViews     Int           @default(0)
  shareCount      Int           @default(0)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  author          User          @relation("BlogAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  listing         Listing?      @relation("ListingBlogs", fields: [listingId], references: [id], onDelete: SetNull)
  comments        BlogComment[] @relation("BlogComments")
  likes           BlogLike[]    @relation("BlogLikes")
  views           BlogView[]    @relation("BlogViews")
  
  @@index([authorId])
  @@index([status])
  @@index([category])
  @@index([publishedAt])
  @@index([isFeatured])
  @@index([slug])
}

model BlogComment {
  id              Int           @id @default(autoincrement())
  
  blogPostId      Int
  userId          Int
  parentId        Int?
  
  content         String        @db.Text
  
  status          CommentStatus @default(VISIBLE)
  
  isAuthorReply   Boolean       @default(false)
  isEdited        Boolean       @default(false)
  editedAt        DateTime?
  
  flagCount       Int           @default(0)
  flaggedBy       Int[]         @default([])
  hiddenBy        Int?
  hiddenAt        DateTime?
  hiddenReason    String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  blogPost        BlogPost      @relation("BlogComments", fields: [blogPostId], references: [id], onDelete: Cascade)
  user            User          @relation("BlogCommentAuthor", fields: [userId], references: [id], onDelete: Cascade)
  parent          BlogComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies         BlogComment[] @relation("CommentReplies")
  likes           BlogCommentLike[] @relation("CommentLikes")
  
  @@index([blogPostId])
  @@index([userId])
  @@index([parentId])
  @@index([status])
  @@index([createdAt])
}

model BlogLike {
  id              Int           @id @default(autoincrement())
  blogPostId      Int
  userId          Int
  createdAt       DateTime      @default(now())
  
  blogPost        BlogPost      @relation("BlogLikes", fields: [blogPostId], references: [id], onDelete: Cascade)
  user            User          @relation("BlogLikesUser", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([blogPostId, userId])
  @@index([blogPostId])
  @@index([userId])
}

model BlogCommentLike {
  id              Int           @id @default(autoincrement())
  commentId       Int
  userId          Int
  createdAt       DateTime      @default(now())
  
  comment         BlogComment   @relation("CommentLikes", fields: [commentId], references: [id], onDelete: Cascade)
  user            User          @relation("CommentLikesUser", fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([commentId, userId])
  @@index([commentId])
  @@index([userId])
}

model ContributorProfile {
  id                  Int       @id @default(autoincrement())
  userId              Int       @unique
  
  tier                Int       @default(0)
  
  totalBlogs          Int       @default(0)
  publishedBlogs      Int       @default(0)
  rejectedBlogs       Int       @default(0)
  totalComments       Int       @default(0)
  approvedComments    Int       @default(0)
  totalLikesReceived  Int       @default(0)
  totalViews          Int       @default(0)
  
  tierUpdatedAt       DateTime?
  previousTier        Int?
  
  isBanned            Boolean   @default(false)
  bannedAt            DateTime?
  bannedReason        String?
  bannedBy            Int?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  user                User      @relation("ContributorProfile", fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([tier])
  @@index([userId])
}

model BlogView {
  id              Int       @id @default(autoincrement())
  blogPostId      Int
  userId          Int?
  sessionId       String?
  ipHash          String?
  userAgent       String?
  referrer        String?
  createdAt       DateTime  @default(now())
  
  blogPost        BlogPost  @relation("BlogViews", fields: [blogPostId], references: [id], onDelete: Cascade)
  
  @@index([blogPostId])
  @@index([userId])
  @@index([createdAt])
}